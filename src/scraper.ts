const fs = require("fs");

const parm_sold =
    '\"polylines\":[\"u`ok`@jw{xFfzZ??w`TgzZ??v`T\"]'

const parm_beach_sold =
    '\"polylines\":[\"}kdk`@tloxFTDSb@MZQ`@k@rAjIdBdI`B{BxC]b@]d@GFSVEFgAvAi@r@qAbBu@`Ae@n@kAzA{AnBzCpAzCpAtAaAPWDm@j@m@^]RFt@Vd@Nl@PtAd@r@Rb@Nd@FBQvAJ|CR`EdBP~AX_@TWBELQd@k@\\\\ZnCbCXVXVVVJJLJXVXVVT@@XVVVVT@@XVXVTPBBXVVVXVDBRRRPMDXx@m@JBb@Fv@Up@KXMN]^Y\\\\k@p@SRUVQXk@~@^T`@Tq@h@c@^g@`@]X]V_@\\\\WPIHa@Z[V_@Z]X_@X]Z_@X_@XGFYTa@\\\\n@Tn@Tn@Rj@RTHRFp@TRFTHjA`@@?p@Vz@X`A\\\\RFbCx@rAb@HDn@RNF`AZlA`@f@P`@Nt@VPFRF\\\\LHBf@PJB\\\\LLDXJh@Pz@XLDp@Tr@VJBn@TJD^Lj@PPF\\\\L|@XDBn@Rz@Xx@Zb@Lp@T|Bv@jBn@mCfBg@XdB?rPgMzEsD|EqD~@|@\\\\ZzArAf@]@?|@k@DCr@e@n@c@h@b@dAlAFFbCpCYPWPIFc@Xc@Va@VYRpAlAbA~@LLNL`A|@ZXXXZXXXZVZXZXXXZXZXZXZZ\\\\X\\\\\\\\\\\\Z\\\\Z^\\\\^\\\\`@^`@^FFJHHHDD\\\\Zb@`@j@h@TRHCb@WZOZQLG\\\\Q\\\\^RMXSXQNLhAx@JIh@I`@D@?ECCEAE???A?C@E?AAC@QAA?A?C?A?KAA?C?C@GAG?C?EAG?C?E?EAE?G?AAK?AAGAA@C@G?G???G?E???G?KAAAE???A?C?EAMBQAI?A?E?A?O?EAA?E?G?AAE@E?C??AAA??A@G?O?G?G@G?CAKAE@G@C?A?AAC?C?CC]AA???E?A?A??@AAEAC??@C?A?AAA?A@C?CAAAA?G?AAC?C?E?A?ACG?KAA?A?C?GAC?CAa@?CCE?A?A?AA??A?C?G???AAG???A?CAC?A???A?A???A???C???AA??C??AA???A?A?A???A?C@AA??A?C?GA??A???A?AAA?A???E???C??AA???A???A?AAA?C?A????AA????AC????AG?A?A??AA?CAA@E?A?AAA?C?A???C???C?AAC?A?AA??A?A?????A?CAA?A???A?EAA?C?C?A?A?A?AAA??AA?A???A?AAA?C?A?CACAEAK@GAA?AAE?AAE?A@C?IAC?E?CACAC?C?AAC?A?A?AAAAA???AAC?C?AAA?EACAA?CAEAE?AAC?A@A??AC???A?AAA?AAA?CAA???AAC?A???A??AC?A?A?EAA?A??AAAC?A???AAA?EAC?EA?AG?AA??A?CAAAGAK?A?AAE?C?E?AAC???AAC?A??AA?A?AAAACAA?AAA?C???AAA?AA??G?A?A?EAC?CAA?C?A?A?A?A????A??A?AA?AE?AAAAC?AAC???C?C?AAA?CAECI?AAA?A?EAA?A?EAG?AAGAC?A?AAA???A?A?A??AEAACG?A?A?A?AAA?CA??A?A?AAC?A?AACAAAC?AACCIAE?A?A?A?C?A?AAIAC?A??AA@C?EACACCI?A?A??AA?A?AAA?Av@I?A???C?A?AAA?A?AACA??A?C?AAA???AAC?A?A???ACE???AAA?AAA?C??AA?AAA@??CCE?A?A?A?ECE?GACAA?AACAEA?AEAAAGACCK?AA?AG?ECECE?CAAAKAC?AAECKAC??AA???ACM?C?A??AE?AA??ACG?CCKAAAI??AA?A?CCGACAIAC?AGKAC?A??AC?EAAAMACAWAE?GA?FKMe@eAyD[o@]k@MQi@u@USYMa@yAf@IA??AA??A???AAAACA??AACAA??AC???AA???CE???AA??A???A??AA????AG???A??CG?A?AAC?AA?AC?????AAA?A???AAC?A?A??AA??CEAA?A??CG?A?AAACEAE?ACIAEEG?A?AACACAA?A???A?A?A????AACIA??ACC??EM@?AA?A?AAACG??AA?CCE?AAE??CGAA?AAA?A???EAA??ACAA???A?C?ECGA??ACG?AAA?ACKA??C?AAAGQ?CCI??EMCGAEAAAGAA??CE?CA?CKIOISCC?A?AGK??A?AE??EKAAGOGIIMAGAAAC?CGQAC?AGOAC????ACAAAC?AA?IYACAC?A??A?AE??AA?AISACCG?A??CCCGGKACIM?AA??AAAEIAC?AIO?AEIACACAAGUACAC??AACECGAA????AAISAAAEACCECE?AA?ACAA?AAAAA?CKO??AA???C??CE??CGAAAA?ACCACAC??AC??A????AAC???AAAAA?A?AAA?AAA????AA?AAAACAEA??AEE??EG?AAA??CAAC??CC?A?ACC?AAA??AAGMAC??ACEG??CE?AAA??EG???AAAACACEG??CEAICEKQ??AC?ACAEE?A??A?AECCEOAAAECE?CAAAA??ACAA???AA???AA?AAA?AACAAAA?AA?GO??EGCKAA??CEAA?AA?AA?AAACC??AA?A??ECAA??AC????CGAAAC??AC??AA??AA??AECA?CCC????AA?AA??ACC?A?????AA?AECA?A?AAAAA??AA?????A??A?GM?ACA?A??AA?AA??ACCCCEGA?EEAA??AACC?AAA@?A?CEII?ACCACAACG??AECCCE?AACAC??EE?AAAAAACEIGGA?A@??ACAA??CEAACC?AA??A?AA?AACCAA??AA?A??AAAA??A??ACCAAAAAA??AACA?A?AAAAAAAAAGG?AAA?AA?AA??A?ACCC??CC??ACCC???A??AA??AACAACAAA??AA???AA??AA?AA?EGAA??AAAAAA??AA??AACC?A??AA??ACA?AA?AEC?AA??AA??ACAAA?AA??AEE??A?AA?AAA?A??AAACAAAAAAACA??A??CA??CEAAA?AA?AEE??AAEGA?ACAAAAAAA??ACCACAA????AA??AAAACC?AAA??A??AA?AA?AA?AAACGG??A??A???AA?AACC?AAA??CAAAAAAAACCC?AA?AAAAAAAC??AAA?AA??AA???AAAAA?AAAAAA??ACA??ACA???AAA?CCACAA????AA?AAACC??AAA??A??AA??ACA??ACCAAA??AKKAA?AA?CC?ACAA???AACC?AAAEE???AAAAAAA??CC??CC??AAA??A??AA??CCAAA?AAAAAAAA?AAAAAA?AAAA?A????AAAAAA??AA??AAECAA??CACA?AA??AA?CCAAA??ACAA??AAAA?AAAAA?AA??AAGEACECAAA?AA??CC??AAAAA??AECAA??A?AAAA??AAECA?AC??A?EE??AA?A??AACAAA?AA?CC??AAA???AAA???EECA??A??AA?ACA?AAAACAAAAACAAA?ACACA??AA????CACAEC?A?AA?AAA?AAAA?A??AAA?A?AACAAA?ACA??CCA?ECAA??CAA?CACCA?AA??CAAA?A??A?AACCA?AA?AEACCAA??AA??A?IEAAGE??A??AAA??AAGEA?AACCAACA?AECCAAAEA???ACAA??AAAA??AA?CA??AA???AA??ACACAAAA?CCECCA???A??CA??AAA?ECAA??CACAACC??A??EA?AC?EEGGA?IE??ECAAAAA???CCAA??A?CAEECAECAAA?AAA?AAA?AAAAA?GECA??AAECAAA?AACACAIGC?CCC?CCKG?????AA???CAECAA??AACAEC@AR_@AAMGAAC?CAAA??AAEAAACACAA?A???AAEACA??A?AACA??AAA?GC?AC?CCA?AAAAA???CA?AAAA?AAAACACACA??CAGC??CCCAA?AAGCKRA?MGCCA?AA??CAAA??A?AAAA????A?CAAAA???A???GE??GAGA??IAAAA?C?E?A???E?G?A?AAA@CA??A?A?A???CA??A???A?IEAAA?AA??C??AA?AA???AA???AAA?CAA?AACAAACAAAAAA?A?AAA?CC??EA?AGCAACAA?AAA?CA??A??A??A?AAMCECCAA?OGC??AUKAACACA??A?CACA??CAA?AAAAE??AA?CA????C??ACCA?CCAC??AAA?A?AAAA??AAAA??EAA???AAA?AAAAA?A?AAAACAAACAEAMAEAC?AAA???A?A?CC??C?A?CA??CAA?A?ECCAIEAAAAA???C?A??AA?CA??AAAA??AAAAGAC?GAA?AAC?A?A???E?C?A?A???C?AAE?GA??C?CAGA??CAA?EAEA??E?A?A?GAA???CACIA??CAGAACCA?A?MECA??CAA???????????A?EA??CAA?A?A?AAA?C???AAE?G?C?KAAAAAIAEAC?GCEAEAA?AAC??AA?A?AAAAAAA?C??ARa@??GAAA????A?AAA?A?AAA?GAA?GACACAC???A???A??ACAA?CAC?AAC?AAEAA?AAA?A?AACAAACAC?AAC?EACAAAEAMCCCC??AA?A?AAA?CAA?CCA?GCA?IAAA??CAA??AGA????GA??GCA?AA??EAGAAAA?A?CA??KAEA??A?GA??AAA?CAAAGAAAIACAC?CAGA??CACAA?A?AACAE?CACAG?AACAA?A?EA????C?CAAAGAE?g@yAcCeA{Ba@}AOwDCiCPc@b@Af@Nb@hAr@DBp@KPo@d@QpAN~@VDDJFAPc@j@J^Lb@A^kAvB{AhAKJHb@aAj@mBj@qA@aAOkCs@m@u@CC_Ao@mDkAeAw@mAqBcC}BuA{@cBs@[MqEyAW[_@{ACoCJg@PSRWKMw@}C?@A?A@C?A@A?A@A?A@A@A@A@A?A@A?A?C@EBA?A@??C??@A?A???A@A?C@A?A?A@??A?C@A@GBC??@C?A???A@A?A?A@A?A@C@A?EB??A@A??@ABABA@?@A@???@A@A@?@A@?@A??@ABA@A@??A@?@A??@?@A?A@CBA?ABA@A?A@?@A?GH??A@?@??A@A@?@A@A@?@C@A@?@A@??A@??A@AB???@A@?@EHA@KL??A@??ABA@??A@CBC@?@A?C@A@A@C@A?C@A?A@??A@A??@A??@C@A@A@A@A@C@EBC@A?A@E?A@A@??A?A@A?A@??A@A?C@A@??A@E@A@A@A?A@CBA@C@EB??A@A?A@EBA??@A?A@C@??C@C@?@A?A?A@E@A?GB??A@??A@C@C@A@A?A?A@??A?A@A?A@E@?@A?A@A?C@A?IDA?A@??A?E@A@EBA?A@A@A@A?A@?@A?A?EBA@C??@??A@A@A?A@C@??EDA@??A@?@?@A@?@A@AB?@A??@?@CJ?@A@?@?@AD???@A?AB?@ABA@?@A@?@A@A@?B?@?@A@?@?@?@A@?@?@A@?B???B?@A@?@?@?@A?@@AB?@?@AB?@?@?@?@CFAB??A@?@A@?@A@?@ABA@?@A@?@?@A??@?@?@?@A??@?@A@AD???BA@?BA@A@??ABA?CD@?EDA@?@A@A@AB?DA@A@??A@?@ABA??@A@?@XNrDhBlB~@zE~BgIrCmC`A??????@?@?B@@@B@@@??@?@@@@B@DB@?@@@?@@BBDB@???@@@@??@@@@@@@?@@BB@@@B?@BF@??@?@???@?F???B?@??A?AH??AD?@???J???B?@?@?B???F?H???@A??@??ABADA?@D?B?@BF?@@H?@BD?B?B@@@B?@?????@?B???@A@?@AF?@???@HJp@MXFEDsFrDiBj@`FbA[v@QDJBj@JLBGMZu@tCl@\"]'


const getPropertyCards = async () => {
    // generate a 1 to 10 array
    const pageArray = Array.from(Array(10).keys()).map(i => i + 1);

    const condition =  '"display_rentals":false,"for_rent":false,"for_sale":false,"just_sold":true,"off_market":false'

    const promises = pageArray.map((page) => {
        return fetch("https://gateway.homes.co.nz/map/cards", {
            "headers": {
                "accept": "application/json, text/plain, */*",
                "accept-language": "en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7",
                "content-type": "application/json",
                "sec-ch-ua": "\"Not.A/Brand\";v=\"8\", \"Chromium\";v=\"114\", \"Microsoft Edge\";v=\"114\"",
                "sec-ch-ua-mobile": "?0",
                "sec-ch-ua-platform": "\"Windows\"",
                "sec-fetch-dest": "empty",
                "sec-fetch-mode": "cors",
                "sec-fetch-site": "same-site",
                "cookie": "_gcl_au=1.1.2047632705.1689720393; _gid=GA1.3.193122468.1689720394; _gat_UA-134832982-1=1; _ga=GA1.3.156390350.1689720394; _gat_gtag_UA_67389338_1=1; _hjSessionUser_185431=eyJpZCI6ImVkZTZhODhjLTYxNmMtNWRlMy04YTlkLTg3Yzk2OTI3MDIyZiIsImNyZWF0ZWQiOjE2ODk3MjAzOTQ2OTcsImV4aXN0aW5nIjpmYWxzZX0=; _hjFirstSeen=1; _hjIncludedInSessionSample_185431=0; _hjSession_185431=eyJpZCI6ImYwMjkxNDc2LWE4NWItNDliMC1iYzhkLWIzZjU4OTcxOGQzMyIsImNyZWF0ZWQiOjE2ODk3MjAzOTQ3MDQsImluU2FtcGxlIjpmYWxzZX0=; nol_fpid=owxlkuovzzawphy8kzylx4bqq6cb51689720394|1689720394491|1689720394491|; _fbp=fb.2.1689720396275.1829014931; __gads=ID=99cc9121b3f92f84:T=1689720409:RT=1689720409:S=ALNI_MZIKYFIdmqX2xBu7kEi3dg5PDCSoQ; __gpi=UID=00000c220c4e3aa5:T=1689720409:RT=1689720409:S=ALNI_MbCpGwEgT5Bf2L3MrxhmF9BGk9s6g; _ga_G8NFYQRLFY=GS1.3.1689720394.1.1.1689720410.0.0.0; _ga_NEZ7TS231V=GS1.1.1689720393.1.0.1689720419.34.0.0; _ga_4MYM4MYPN0=GS1.1.1689720393.1.1.1689720419.34.0.0",
                "Referer": "https://homes.co.nz/",
                "Referrer-Policy": "strict-origin-when-cross-origin"
            },
            "body": "{"+parm_sold+",\"page\":" + page + ",\"limit\":100,\"display_rentals\":false,\"for_rent\":false,\"for_sale\":false,\"just_sold\":true,\"off_market\":false}",
            "method": "POST"
        }).then(res => res.json());
    })

    const results = await Promise.all(promises);

    return results.reduce((acc, cur) => {
        return acc.concat(cur.cards);
    }, []);
}

const getPropertyDetails = async (properties) => {
    const detailsData = []
    for (const p of properties) {
        const response = await fetch(`https://api-gateway.homes.co.nz/details?property_id=${p.id}`, {
            "headers": {
                "accept": "application/json, text/plain, */*",
                "accept-language": "en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7",
                "sec-ch-ua": "\"Not.A/Brand\";v=\"8\", \"Chromium\";v=\"114\", \"Microsoft Edge\";v=\"114\"",
                "sec-ch-ua-mobile": "?0",
                "sec-ch-ua-platform": "\"Windows\"",
                "sec-fetch-dest": "empty",
                "sec-fetch-mode": "cors",
                "sec-fetch-site": "same-site"
            },
            "referrer": "https://homes.co.nz/",
            "referrerPolicy": "strict-origin-when-cross-origin",
            "body": null,
            "method": "GET",
            "mode": "cors",
            "credentials": "include"
        });

        const responseJson = await response.json()

        p.property_details = {...p.property_details, ...responseJson.property}

        detailsData.push(p)
    }
    return detailsData
}

const formatePrice = (price) => {
    if (typeof price === "number") {
        return price
    }
    return parseFloat(price.replace("$", "").replace(",", ""))
}


const convertData = () => {
    const data = fs.readFileSync("../data/raw_data.json");
    const properties_raw = JSON.parse(data);

    const properties = properties_raw.map(p => {
        return {
            property_id: p.property_id,
            date: p.date,
            price: p.price,
            sales_count: p.sales_count,
            url: p.url,

            address: p.property_details.address,
            street: p.property_details.street,
            street_number: p.property_details.street_number,
            suburb: p.property_details.suburb,

            solar: p.solar?.potential,

            capital_value: p.property_details.capital_value_digit,
            land_value: formatePrice(p.property_details.land_value_digit),
            improvement_value: formatePrice(p.property_details.improvement_value_digit),

            display_estimated_rental_lower_value: formatePrice(p.property_details.display_estimated_rental_lower_value),
            display_estimated_rental_upper_value: formatePrice(p.property_details.display_estimated_rental_upper_value),

            display_estimated_lower_value: formatePrice(p.property_details.display_estimated_lower_value),
            display_estimated_upper_value: formatePrice(p.property_details.display_estimated_upper_value),

            estimated_rental_yield: p.property_details.estimated_rental_yield,

            num_car_spaces: p.property_details.num_car_spaces,
            bath_estimate: p.property_details.bath_estimate,
            bed_estimate: p.property_details.bed_estimate,
            floor_area: p.property_details.floor_area,
            land_area: p.property_details.land_area,
            has_deck: p.property_details.has_deck,

            decade_built: p.property_details.decade_built,

            agent: `${p.agent?.branch?.branch_name} ${p.agent?.branch?.brand_name}`
        }
    })

    return properties
}

const run = async () => {
    //scrap the properties info
    const propertyCards = await getPropertyCards()
    const propertyDetails = await getPropertyDetails(propertyCards)
    fs.writeFileSync("../data/raw_data.json", JSON.stringify(propertyDetails));

    // data reshape
    const refinedProperties = convertData()
    fs.writeFileSync("../data/refined_data.json", JSON.stringify(refinedProperties));
}

run().then().catch(e => console.error(e))



